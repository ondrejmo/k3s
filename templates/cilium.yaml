---

apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: cilium
  namespace: kube-system

spec:
  chart: https://{{ k3s_host }}:6443/static/charts/cilium-{{ k3s_cilium_version }}.tgz
  targetNamespace: kube-system
  bootstrap: true
  valuesContent: |-
    kubeProxyReplacement: true
    # DISCLAIMER: this will bite in the ass in setup with multiple masters
    k8sServiceHost: {{ k3s_host }}
    k8sServicePort: 6443
    encryption:
      enabled: true
      type: wireguard
      nodeEncryption: true
    prometheus:
      enabled: true
      serviceMonitor:
        enabled: true
        trustCRDsExist: true
    operator:
      replicas: 1
      prometheus:
        enabled: true
        serviceMonitor:
          enabled: true
    hubble:
      enabled: true
      metrics:
        # enabled: ...
        enableOpenMetrics: true
        serviceMonitor:
          enabled: true
      relay:
        enabled: true
        prometheus:
          enabled: true
          serviceMonitor:
            enabled: true
      ui:
        enabled: true
        frontend:
          server:
            ipv6:
              enabled: false
    ipam:
      operator:
        clusterPoolIPv4PodCIDRList: [ 10.42.0.0/16 ]
